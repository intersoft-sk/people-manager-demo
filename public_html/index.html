<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Beef weighting demo - Turin 2014</title>

        <!-- Bootstrap -->
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body onload="loadData();">


        <div class="container">

            <div class="row">
                <h1>Digital Scale Simulator</h1>
            </div>

            <hr/>
            <br/>

            <div class="row">
                <div class="col-md-8">

                    <svg
                        xmlns:dc="http://purl.org/dc/elements/1.1/"
                        xmlns:cc="http://creativecommons.org/ns#"
                        xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                        xmlns:svg="http://www.w3.org/2000/svg"
                        xmlns="http://www.w3.org/2000/svg"
                        xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
                        xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
                        width="630"
                        height="372.96356"
                        id="svg2"
                        version="1.1"
                        inkscape:version="0.48.4 r9939"
                        sodipodi:docname="digital_scale_design.svg">
                    <defs
                        id="defs4" />
                    <sodipodi:namedview
                        id="base"
                        pagecolor="#ffffff"
                        bordercolor="#666666"
                        borderopacity="1.0"
                        inkscape:pageopacity="0.0"
                        inkscape:pageshadow="2"
                        inkscape:zoom="0.64137056"
                        inkscape:cx="618.22133"
                        inkscape:cy="101.88219"
                        inkscape:document-units="px"
                        inkscape:current-layer="layer1"
                        showgrid="false"
                        inkscape:window-width="1920"
                        inkscape:window-height="1027"
                        inkscape:window-x="0"
                        inkscape:window-y="31"
                        inkscape:window-maximized="1"
                        fit-margin-top="0"
                        fit-margin-left="0"
                        fit-margin-right="0"
                        fit-margin-bottom="0" />
                    <metadata
                        id="metadata7">
                    <rdf:RDF>
                        <cc:Work
                            rdf:about="">
                            <dc:format>image/svg+xml</dc:format>
                            <dc:type
                                rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                            <dc:title />
                        </cc:Work>
                    </rdf:RDF>
                    </metadata>
                    <g
                        inkscape:label="Layer 1"
                        inkscape:groupmode="layer"
                        id="layer1"
                        transform="translate(-16.09375,-318.66144)">
                    <rect
                        style="fill:#ffffff;fill-opacity:1;fill-rule:evenodd;stroke:#000000;stroke-width:15.8600235;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"
                        id="rect2985"
                        width="614.13995"
                        height="288.37875"
                        x="24.035061"
                        y="395.30765" />
                    <path
                        style="font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;text-indent:0;text-align:start;text-decoration:none;line-height:normal;letter-spacing:normal;word-spacing:normal;text-transform:none;direction:ltr;block-progression:tb;writing-mode:lr-tb;text-anchor:start;baseline-shift:baseline;color:#000000;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:15;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate;font-family:Sans;-inkscape-font-specification:Sans"
                        d="m 201.59145,318.66144 0,13.59168 15.05061,47.92555 c 0,0 1.6004,3.83325 7.38476,7.83028 6.02863,4.16586 10.55285,3.42294 10.55285,3.42294 l 193.50495,0.31172 c 0,0 6.97128,-0.46853 11.71854,-5.37026 4.19655,-4.33308 5.24568,-6.35349 5.24568,-6.35349 l 14.86273,-48.46721 0,-12.89121 -7.93002,0 -242.4601,0 z m 15.86002,12.707 226.60008,0 c 0,0 -10.97973,45.43916 -13.98846,48.36865 -3.56482,3.47091 -193.74463,2.62482 -197.0758,-0.15172 -3.6818,-3.06879 -15.53582,-48.21693 -15.53582,-48.21693 z"
                        id="rect3763"
                        inkscape:connector-curvature="0"
                        sodipodi:nodetypes="cccsccsccccccccssc" />
                    <path
                        sodipodi:type="arc"
                        style="fill:#ffffff;fill-opacity:1;stroke:#000000;stroke-width:15;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"
                        id="path3769"
                        sodipodi:cx="365.23349"
                        sodipodi:cy="410.82379"
                        sodipodi:rx="51.062523"
                        sodipodi:ry="51.062523"
                        d="m 416.29601,410.82379 c 0,28.20105 -22.86147,51.06252 -51.06252,51.06252 -28.20105,0 -51.06252,-22.86147 -51.06252,-51.06252 0,-28.20105 22.86147,-51.06252 51.06252,-51.06252 28.20105,0 51.06252,22.86147 51.06252,51.06252 z"
                        transform="matrix(-1.0573349,0,0,-1.0573349,555.89588,974.23872)" />
                    <a onclick="chopAndWeigh();"><path
                        transform="matrix(-0.63507966,0,0,-0.63507966,401.67414,800.76625)"
                        d="m 416.29601,410.82379 c 0,28.20105 -22.86147,51.06252 -51.06252,51.06252 -28.20105,0 -51.06252,-22.86147 -51.06252,-51.06252 0,-28.20105 22.86147,-51.06252 51.06252,-51.06252 28.20105,0 51.06252,22.86147 51.06252,51.06252 z"
                        sodipodi:ry="51.062523"
                        sodipodi:rx="51.062523"
                        sodipodi:cy="410.82379"
                        sodipodi:cx="365.23349"
                        id="path3771"
                        style="fill:#ffffff;fill-opacity:1;stroke:#000000;stroke-width:15;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"
                        sodipodi:type="arc" /></a>
                    <rect
                        style="fill:#aaccff;fill-opacity:1;stroke:#000000;stroke-width:15.8600235;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"
                        id="rect3773"
                        width="248.78734"
                        height="63.98119"
                        x="356.90933"
                        y="425.10355" />
                    <text
                        xml:space="preserve"
                        style="font-size:40.65630341px;font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;line-height:125%;letter-spacing:0px;word-spacing:0px;fill:#000000;fill-opacity:1;stroke:none;font-family:Ubuntu Mono;-inkscape-font-specification:Ubuntu Mono Bold"
                        x="551.966"
                        y="451.14987"
                        id="text3796"
                        sodipodi:linespacing="125%"
                        transform="scale(0.96129213,1.0402665)"><tspan
                        sodipodi:role="line"
                        id="tspan3798"
                        x="551.966"
                        y="451.14987"
                        style="font-size:39.80807495px">0.0</tspan></text>
                    </g>
                    </svg>

                </div>
                <div class="col-md-4">
                    <form role="form">
                        <div class="form-group">
                            <label for="userSelect">Select User</label>
                            <select id="userSelect" class="form-control" onchange="loadData();">
                                <option personid="1">John Butcher</option>
                                <option personid="2">Daisy Butcher</option>
                            </select>
                        </div>
                        <button id="btn:caw" type="button" class="btn btn-danger btn-lg btn-block" onclick="chopAndWeigh();">Chop and Weigh</button>
                    </form>
                    <hr/>
                    <div class="panel panel-primary">
                        <div class="panel-heading">ERP Data</div>
                        <table class="table table-bordered">
                            <tr>
                                <td>ID:</td>
                                <td id="erp:id">1</td>
                            </tr>
                            <tr>
                                <td>Name:</td>
                                <td id="erp:name">John Butcher</td>
                            </tr>
                            <tr>
                                <td>Roles:</td>
                                <td id="erp:roles">butcher, manager</td>
                            </tr>
                            <tr>
                                <td>Break Duration:</td>
                                <td id="erp:breakduration">20</td>
                            </tr>
                        </table>
                    </div>
                    <div class="panel panel-primary">
                        <div class="panel-heading">People Manager's Data</div>
                        <table class="table table-bordered">
                            <tr>
                                <td>ID:</td>
                                <td id="pm:id"></td>
                            </tr>
                            <tr>
                                <td>Available:</td>
                                <td id="pm:available"></td>       
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>                        

        <script type="text/javascript">            
            
            function fillPersonSelect(people) {
                console.log("fillPersonSelect called")
                var personSelect = document.getElementById("userSelect");
                people.forEach(function(element, index, array) {
                    console.log(index);
                    var personOptElem = new Option(element.name, element.name);
                    personOptElem.setAttribute("personid", element.id);
                    personSelect.options[index] = personOptElem;
                    personSelect.selectedIndex = 0;
                });
            }
            
            function loadERPData() {
                // Load from person erpID
                var personSelect = document.getElementById("userSelect");
                console.log(personSelect.options);
                var erpId = personSelect.options[personSelect.selectedIndex].getAttribute("personid");
                
                var request = new XMLHttpRequest();
                request.open("GET", "http://localhost:8080/pmrest/ERP?action=list&by=id&id="+erpId, false);
                request.setRequestHeader("Content-Type", "application/json");
                request.onreadystatechange = function() {
                    if (request.readyState === 4 && request.status === 200) {
                        console.log(request.responseText);
                        var response = JSON.parse(request.responseText);                        
                        fillERPPanel(response);
                    }
                }
                request.send();
            }   
            
            function fillERPPanel(person) {
                var erpId = document.getElementById("erp:id");
                erpId.innerHTML = person.id;
                var erpName = document.getElementById("erp:name");
                erpName.innerHTML = person.name;
                var erpRoles = document.getElementById("erp:roles");
                erpRoles.innerHTML = person.roles;
                var erpBreakDuration = document.getElementById("erp:breakduration");
                erpBreakDuration.innerHTML = person.breakduration;
            }
                        
        </script>
        
        <script defer type="text/javascript">
            function loadPMData() {
                // Load from person erpID
                var personSelect = document.getElementById("userSelect");
                console.log(personSelect.options);
                var erpId = personSelect.options[personSelect.selectedIndex].getAttribute("personid");
                
                var request = new XMLHttpRequest();
                request.open("GET", "http://localhost:8080/pmrest/Proxy?action=list&by=erpId&id="+erpId, false);
                request.setRequestHeader("Content-Type", "application/json");
                request.onreadystatechange = function() {
                    if (request.readyState === 4 && request.status === 200) {
                        var response = JSON.parse(request.responseText);
                        fillPMPanel(response);
                    }
                }
                request.send();
            }                        
            
            function fillPMPanel(person) {
                var pmId = document.getElementById("pm:id");
                pmId.innerHTML = person.id;
                var pmAvailable = document.getElementById("pm:available");
                pmAvailable.innerHTML = person.available;
                
                var availElem = document.getElementById("pm:available");
                if (person.available === true) {
                    availElem.setAttribute("class", "success");
                } else {
                    availElem.setAttribute("class", "danger");
                }
                
                var displayText = document.getElementById("tspan3798");
                if (person.available === true && displayText.innerHTML === "blk") {
                    displayText.innerHTML = "0.0";
                } else if (person.available === false) {
                    displayText.innerHTML = "blk";
                }
                
                var rfidReaderPad = document.getElementById("path3771");
                if (person.available === true) {
                    rfidReaderPad.setAttribute("style", "fill:#82FA58;fill-opacity:1;stroke:#000000;stroke-width:15;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none");
                } else {
                    rfidReaderPad.setAttribute("style", "fill:#FA5858;fill-opacity:1;stroke:#000000;stroke-width:15;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none");
                }
                
                var cawButton = document.getElementById("btn:caw");
                if (person.available === true) {
                    cawButton.disabled = false;
                } else {
                    cawButton.disabled = true;
                }
            }
            
            function loadData() {
                loadERPData();
                loadPMData();
                resource_timer = setTimeout(loadData, 1000);
            }
        </script>
        
        <script defer type="text/javascript">
            function chopAndWeigh() {

                var personSelect = document.getElementById("userSelect");
                var erpId = personSelect.options[personSelect.selectedIndex].getAttribute("personid");
                var personName = personSelect.options[personSelect.selectedIndex].value;
                
                var beefWeight = Math.round10(getRandomArbitrary(500.0, 800.0), 0);
                var beefWeighTime = new Date();
                
                var displayText = document.getElementById("tspan3798");
                displayText.innerHTML = beefWeight;
                
                var cvEvent = {};
                cvEvent.erpId = erpId;
                cvEvent.personName = personName;
                cvEvent.beefWeight = beefWeight;
                cvEvent.beefWeighTime = beefWeighTime;
                cvEvent.type = "event:caw";
                var cvEventJSON = JSON.stringify(cvEvent);
                
                console.log("CAW Event Sent: " + cvEventJSON);
                
                var request = new XMLHttpRequest();
                request.open("POST", "http://localhost:8080/pmrest/Proxy", false);
                request.setRequestHeader("Content-Type", "application/json");
                request.send(cvEventJSON);
            }

            function getRandomArbitrary(min, max) {
                return Math.random() * (max - min) + min;
            }

            function decimalAdjust(type, value, exp) {
                // If the exp is undefined or zero...
                if (typeof exp === 'undefined' || +exp === 0) {
                    return Math[type](value);
                }
                value = +value;
                exp = +exp;
                // If the value is not a number or the exp is not an integer...
                if (isNaN(value) || !(typeof exp === 'number' && exp % 1 === 0)) {
                    return NaN;
                }
                // Shift
                value = value.toString().split('e');
                value = Math[type](+(value[0] + 'e' + (value[1] ? (+value[1] - exp) : -exp)));
                // Shift back
                value = value.toString().split('e');
                return +(value[0] + 'e' + (value[1] ? (+value[1] + exp) : exp));
            }

            // Decimal round
            if (!Math.round10) {
                Math.round10 = function(value, exp) {
                    return decimalAdjust('round', value, exp);
                };
            }
        </script>

    </body>
</html>
